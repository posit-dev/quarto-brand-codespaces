---
title: "World Happiness Report"
subtitle: "Happiness Trends and Contributing Factors (2011-2024)"
format: html
execute:
  warning: false
  message: false
---

```{python}
#| label: setup
import pandas as pd
import numpy as np
from plotnine import *
from quarto import theme_brand_plotnine
from brand_yml import Brand

whr = pd.read_csv("data/whr.csv")

brand = Brand.from_yaml("_brand.yml")

theme_whr = (
  theme_minimal()
  + theme_brand_plotnine("_brand.yml")
  + theme(
    plot_subtitle=element_text(size=12),
    plot_title=element_text(size=14)
  ) 
)
```

```{python}
#| label: global-trends
global_trends = (
  whr
  .groupby('year')
  .agg({
    'ladder_score': ['mean', 'median', 'min', 'max', 'count']
  })
  .round(3)
)

global_trends.columns = ['mean_happiness', 'median_happiness', 'min_happiness', 'max_happiness', 'countries_count']
global_trends = global_trends.reset_index()

global_plot = (
  ggplot(global_trends, aes(x='year', y='mean_happiness')) 
  + geom_line(color = brand.color.palette['teal'], size=1.5)
  + geom_point(color = brand.color.palette['teal'], size=3)
  + scale_x_continuous(breaks=range(2011, 2025, 1)) 
  + scale_y_continuous(limits=(5.2, 5.7), breaks=np.arange(5.2, 5.8, 0.1))
  + theme_whr
  + theme(
    axis_title=element_text(size=12),
    axis_text=element_text(size=10)
  ) 
  + labs(
    title="Global Average Happiness Over Time (2011-2024)",
    subtitle="Average happiness has increased over the past 12 years",
    x="Year",
    y="Average Happiness Score"
  ) 
)

global_plot
```


```{python}
#| label: country-changes
most_changed_countries = (
  whr.dropna(subset=["year", "ladder_score"])
  .groupby("country_name")
  .apply(
    lambda g: pd.Series({
      "first_year": g["year"].min(),
      "last_year": g["year"].max(),
      "first_score": g.sort_values("year")["ladder_score"].iloc[0],
      "last_score": g.sort_values("year")["ladder_score"].iloc[-1],
    })
  )
  .reset_index()
)

most_changed_countries["change"] = (
  most_changed_countries["last_score"] - most_changed_countries["first_score"]
)
most_changed_countries["years_span"] = (
  most_changed_countries["last_year"] - most_changed_countries["first_year"]
)

most_changed_countries = most_changed_countries[most_changed_countries["years_span"] >= 10]

most_changed_countries["improvement"] = most_changed_countries["change"] > 0

most_changed_countries = (
  most_changed_countries
  .assign(abs_change=lambda df: df["change"].abs())
  .groupby("improvement", group_keys=False)
  .apply(lambda g: g.nlargest(5, "abs_change"))
  .reset_index(drop=True)
)

# Data for each plot
improvements_df = (
  whr.merge(
    most_changed_countries.loc[most_changed_countries["improvement"] == True, ["country_name"]],
    on="country_name",
    how="inner"
  )
)

declines_df = (
  whr.merge(
    most_changed_countries.loc[most_changed_countries["improvement"] == False, ["country_name"]],
    on="country_name",
    how="inner"
  )
)

improvements_df["year"] = pd.to_numeric(improvements_df["year"], errors="coerce")
declines_df["year"] = pd.to_numeric(declines_df["year"], errors="coerce")

# Greatest improvements
(
  ggplot(improvements_df, aes(x="year", y="ladder_score", color="country_name"))
  + geom_line(size=1.2)
  + geom_point(size=2.5)
  + labs(
    title="National Happiness Over Time",
    subtitle="For countries with the largest increases in happiness since 2011",
    x="Year",
    y="Happiness Score",
    color=""
  )
  + theme_whr
)
```

```{python}
#| label: declines
(
  ggplot(declines_df, aes(x="year", y="ladder_score", color="country_name"))
  + geom_line(size=1.2)
  + geom_point(size=2.5)
  + scale_color_manual(values=[
    "#d62728", "#ff7f0e", "#8c564b", "#e377c2", "#7f7f7f"
  ])
  + labs(
    title="National Happiness Over Time",
    subtitle="For countries with the largest decreases in happiness since 2011",
    x="Year",
    y="Happiness Score",
    color=""
  )
  + theme_whr
)
```

## Conclusions

1. **Global happiness is gradually improving**: The world has become slightly happier over the past decade.

2. **Social connections and economic conditions are most important**: GDP per capita and social support are the strongest contributors to national happiness. 

3. **Multiple pathways to happiness**: The top countries show that there are different combinations of factors that can lead to high happiness levels.

5. **Crises can severely affect happiness**: Countries experiencing political upheaval or economic crisis show dramatic happiness declines.